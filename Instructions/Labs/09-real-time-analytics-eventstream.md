---
lab:
  title: Microsoft Fabric 中的 Eventstream 入门
  module: Get started with Eventstream in Microsoft Fabric
---
# Microsoft Fabric 中的 Eventstream 入门

事件流是 Microsoft Fabric 中的一项功能，可捕获、转换实时事件并将其路由到各种目标，并且无需编写代码。 可向事件流添加事件数据源、路由目标以及事件处理程序（如果需要转换）。 Microsoft Fabric 的 EventStore 是一个监视选项，用于维护群集中的事件，并提供一种方法来了解群集或工作负载在给定时间点的状态。 可以向 EventStore 服务查询可用于群集中的每个实体和实体类型的事件。 这意味着可在群集、节点、应用程序、服务、分区和分区副本等不同级别查询事件。 EventStore 服务还能够将群集中的事件相关联。 通过查看在同一时间从可能已相互影响的不同实体写入的事件，EventStore 服务可以将这些事件进行关联来帮助查明群集中发生各项活动的原因。 另一种监视和诊断 Microsoft Fabric 群集的方法是使用 EventFlow 聚合和收集事件。

完成本实验室大约需要 30 分钟。

> **注意**：需要 [Microsoft Fabric 试用版](https://learn.microsoft.com/fabric/get-started/fabric-trial) 才能完成本练习。

## 创建工作区

在 Fabric 中处理数据之前，创建一个已启用的 Fabric 试用版的工作区。

1. 登录到 [Microsoft Fabric 主页](https://app.fabric.microsoft.com/home?experience=fabric) (`https://app.fabric.microsoft.com/home?experience=fabric`)，然后选择“**Power BI**”。
2. 在左侧菜单栏中，选择“工作区”（图标类似于 &#128455;）。
3. 使用所选名称创建一个新工作区，并选择包含 Fabric 容量的授权模式（试用、高级或 Fabric）  。
4. 打开新工作区时，它应为空，如下所示：

   ![Power BI 中空工作区的屏幕截图。](./Images/new-workspace.png)
5. 在 Power BI 门户的左下角，选择“Power BI”图标，然后切换到“实时智能”体验********。

## 创建实时智能 Eventhouse

1. 在 Microsoft Fabric 的实时智能主页中，创建新的 **Eventhouse**，并为其指定所选的唯一名称。
1. 关闭显示的所有建议或提示，直到看到新的空事件屋。

    ![新事件屋的屏幕截图](./Images/create-eventhouse.png)

## 创建 KQL 数据库

1. 在“实时智能 Eventhouse”仪表板内，选中“KQL 数据库 +”框********。
1. 你将可以选择创建“**新数据库(默认)**”或创建“**新快捷方式数据库(后继)**”。

    >**注意：** 使用后继数据库功能可将另一群集中的数据库附加到 Azure 数据资源管理器群集。 后继数据库以只读模式附加，因此可以查看其数据，并针对已引入先导数据库的数据运行查询。 后继数据库会同步先导数据库中的更改。 由于同步的缘故，数据可用性方面会存在几秒钟到几分钟的数据延迟。 具体的延迟时长取决于先导数据库元数据的总体大小。 先导数据库和后继数据库使用相同的存储帐户来提取数据。 存储由先导数据库拥有。 后继数据库无需引入数据即可查看数据。 由于附加的数据库是只读的数据库，因此无法修改数据库中除缓存策略、主体和权限以外的其他数据、表和策略。

1. 创建新数据库并将其命名为 `Eventhouse-DB`。

## 创建 Eventstream

1. 在 KQL 数据库的主页中，选择“**获取数据**”。
2. 对于数据源，请选择“**Eventstream**” > “**新建 Eventstream**”。 将 Eventstream 命名为 `bicycle-data`。

    只需片刻即可在工作区完成创建新事件流。 建立之后，你将自动重定向到主编辑器，准备好开始将源集成到 Eventstream 中。

    ![创建新事件流的屏幕截图。](./Images//name-eventstream.png)

## 建立 Eventstream 源

1. 在 Eventstream 画布中，选择“**使用示例数据**”。
2. 将该源命名为 `Bicycles`，并选择“**自行车**”示例数据。

    流将被映射，并且会自动显示在**事件流画布**上。

   ![查看事件流画布](./Images/real-time-intelligence-eventstream-sourced.png)

## 添加目标

1. 在“**转换事件或添加目标**”下拉列表中，选择“**Eventhouse**”。
1. 在“**Eventhouse**”窗格中，配置以下设置选项。
   - **数据引入模式：** 引入前的事件处理
   - **目标名称：**`Bicycle-database`
   - **工作区：***选择在本练习开始时创建的工作区*
   - **Eventhouse**：*选择事件屋*
   - **KQL 数据库：** Eventhouse-DB
   - **目标表：** 创建名为 `bike-count` 的新表
   - **输入数据格式：** JSON

   ![具有引入模式的 KQL 数据库事件流](./Images/kql-database-event-processing-before-ingestion.png)

1. 在“**Eventhouse**”窗格中，选择“**保存**”。 
1. 在工具栏上，选择“发布”****。
1. 等待一分钟左右，让数据目标变为活动状态。

## 查看捕获的数据

创建的事件流从自行车数据的示例源中获取数据，并将其加载到事件屋的数据库中。 可以通过查询数据库中的表来查看捕获的数据。

1. 在左侧菜单栏中，选择“**Eventhouse-DB**”数据库。
1. 在 **Eventhouse-DB** KQL 数据库的“**...**”菜单中，选择“**查询数据**”。
1. 在查询窗格中，修改第一个示例查询，如下所示：

    ```kql
    ['bike-count']
    | take 100
    ```

1. 选择查询代码并运行，以查看表中的 100 行数据。

    ![KQL 查询的屏幕截图。](./Images/kql-query.png)

## 转换事件数据

已捕获的数据与源数据一致，未经过更改。 在许多情况下，可能需要在将事件流中的数据加载到目标之前对其进行转换。

1. 在左侧菜单栏中，选择“**Bicycle-data**”事件流。
1. 在工具栏上，选择“**编辑**”以编辑事件流。

1. 在“**转换事件**”菜单中，选择“**分组依据**”，以将新的“**分组依据**”节点添加到事件流。
1. 将连接从“**Bicycle-data**”节点的输出拖到新的“**分组依据**”节点的输入，然后使用“**分组依据**”节点中的*铅笔*图标对其进行编辑。

   ![向转换事件添加“分组依据”。](./Images/eventstream-add-aggregates.png)

1. 配置“**分组依据**”设置部分的属性：
    - **操作名称：** GroupByStreet
    - **聚合类型：***选择*“求和”
    - **字段：***选择*No_Bikes。 *然后选择“**添加**”以创建函数* SUM_No_Bikes
    - **组聚合依据（可选）：** 街道
    - 时间窗口：翻转****
    - **持续时间**：5 秒
    - **偏移**：0 秒

    > **备注**：此配置将导致事件流每 5 秒计算一次每条街道上的自行车总数。
      
1. 保存配置并返回到事件流画布，此时会显示一个错误提示（因为需要通过转换将组的输出存储在某个位置！）。

1. 使用“**GroupByStreet**”节点右侧的 **+** 图标来添加新的“**Eventhouse**”节点。
1. 使用以下选项配置新的事件屋节点：
   - **数据引入模式：** 引入前的事件处理
   - **目标名称：**`Bicycle-database`
   - **工作区：***选择在本练习开始时创建的工作区*
   - **Eventhouse**：*选择事件屋*
   - **KQL 数据库：** Eventhouse-DB
   - **目标表：** 创建名为 `bikes-by-street` 的新表
   - **输入数据格式：** JSON

   ![分组数据表的屏幕截图。](./Images/group-by-table.png)

1. 在“**Eventhouse**”窗格中，选择“**保存**”。 
1. 在工具栏上，选择“发布”****。
1. 等待一分钟左右，让更改变为活动状态。

## 查看转换后的数据

现在，可以查看事件流已转换并加载到表中的自行车数据

1. 在左侧菜单栏中，选择“**Eventhouse-DB**”数据库。
1. 在 **Eventhouse-DB** KQL 数据库的“**...**”菜单中，选择“**查询数据**”。
1. 在查询窗格中，修改示例查询，如下所示：

    ```kql
    ['bikes-by-street']
    | take 100
    ```

1. 选择查询代码并运行，以查看表中的前 100 行。

    ![KQL 查询的屏幕截图。](./Images/kql-group-query.png)

    > **提示**：还可以使用 SQL 语法查询表。 例如，尝试查询 `SELECT TOP 100 * FROM bikes-by-street`。

## 清理资源

在本练习中，你已创建了事件屋，并使用事件流填充了其数据库中的表。

如果已完成 KQL 数据库探索，可删除为本练习创建的工作区。

1. 在左侧栏中，选择你的工作区的图标。
2. 在工具栏中，选择“**工作区设置**”。
3. 在“常规”部分中，选择“删除此工作区”。********
。
